# 🎯 完整对话流程测试指南

## 目标

通过 Swagger UI 手动测试完整的 AI 对话流程，验证：

- RAG 知识库检索
- 客户分类
- 转人工逻辑
- 对话历史管理

---

## 📋 测试步骤

### Step 1: 访问 API 文档

✅ 浏览器打开: **http://localhost:8000/docs**

---

### Step 2: 创建测试客户

**端点**: `POST /api/customers`

**点击步骤**:

1. 找到 `POST /api/customers`
2. 点击展开
3. 点击 "Try it out"
4. 填写 Request body:

```json
{
  "name": "王经理",
  "email": "wang@company.com",
  "company": "某电力公司",
  "phone": "13900139000",
  "language": "zh-cn"
}
```

5. 点击 "Execute"
6. 查看响应，记下 `customer_id`（例如：3）

**预期结果**:

- Status: 201 Created
- 返回 customer_id

---

### Step 3: 第 1 轮对话 - 初步咨询

**端点**: `POST /api/chat`

**Request body**:

```json
{
  "customer_id": 3,
  "message": "你好，我想了解大疆Matrice 30无人机",
  "language": "zh-cn"
}
```

**观察重点**:

- ✅ `answer`: AI 的回复内容
- ✅ `confidence`: 置信度（应该>0.7）
- ✅ `should_handoff`: false（初次咨询不转人工）
- ✅ `product_tag`: "M30"（产品识别）

**预期**: AI 会介绍 M30 的基本信息

---

### Step 4: 第 2 轮对话 - 技术问题（RAG 检索）

**Request body**:

```json
{
  "customer_id": 3,
  "message": "M30的续航时间和飞行距离是多少？",
  "language": "zh-cn"
}
```

**观察重点**:

- ✅ `answer`: 应该包含具体的数字（来自知识库）
- ✅ `confidence`: 应该很高（0.85+）
- ✅ 检查 Response 中是否提到"根据 XX 手册"

**验证**: 答案应该来自知识库，不是 LLM 编造

---

### Step 5: 第 3 轮对话 - 深入技术

**Request body**:

```json
{
  "customer_id": 3,
  "message": "M30适合用于电力巡检吗？有什么优势？",
  "language": "zh-cn"
}
```

**观察重点**:

- ✅ AI 能否结合之前对话给出建议
- ✅ 多轮对话上下文是否保持

---

### Step 6: 第 4 轮对话 - 购买意向（触发转人工）

**Request body**:

```json
{
  "customer_id": 3,
  "message": "价格是多少？我们需要购买50台M30用于电力线路巡检项目，预算充足",
  "language": "zh-cn"
}
```

**观察重点**:

- ✅ `should_handoff`: **应该为 true**（购买意向）
- ✅ `confidence`: 可能较低
- ✅ Answer 应该建议联系销售

**验证转人工逻辑**:

- 关键词"价格"、"购买"、"50 台" → 触发
- 这是高价值客户信号

---

### Step 7: 测试客户分类

**端点**: `POST /api/classify/3`

**无需 Request body**，直接 Execute

**预期结果**:

```json
{
  "category": "high_value",
  "priority_score": 5,
  "reason": "客户表达了购买50台的明确意向，属于大额采购，且有具体应用场景（电力巡检）"
}
```

**验证**:

- ✅ Category 应该是"high_value"
- ✅ Priority 应该是 4 或 5
- ✅ Reason 应该提到"大额采购"

---

### Step 8: 查看客户列表

**端点**: `GET /api/customers`

**直接 Execute**

**查看结果**:

```json
{
  "total": 3,
  "customers": [
    {
      "id": 3,
      "name": "王经理",
      "category": "high_value",
      "priority_score": 5
    },
    ...
  ]
}
```

**验证**:

- ✅ 王经理在列表顶部（优先级最高）
- ✅ 分类为 high_value

---

### Step 9: 查看对话历史

**端点**: `GET /api/conversations/{id}`

需要先找到 conversation_id：

1. 在之前的 chat 响应中不会直接返回
2. 可以直接尝试 `GET /api/conversations/1`（第一个会话）

**预期**:

```json
{
  "conversation_id": 1,
  "customer_id": 3,
  "status": "active",
  "message_count": 8,
  "messages": [...]
}
```

---

## ✅ 完整测试检查清单

完成后确认：

- [ ] 客户创建成功
- [ ] 第 1 轮：AI 识别出 M30 产品
- [ ] 第 2 轮：AI 从知识库检索到准确数据
- [ ] 第 3 轮：AI 理解上下文
- [ ] 第 4 轮：触发转人工（should_handoff=true）
- [ ] 客户分类为 high_value
- [ ] 优先级评分为 5
- [ ] 对话历史完整保存

---

## 🎯 额外测试场景

### 测试产品识别

**M400 测试**:

```json
{
  "customer_id": 3,
  "message": "Matrice 400和M30有什么区别？"
}
```

预期：识别出 M400 产品

### 测试低价值客户

创建新客户，发送：

```json
{
  "message": "有免费试用吗？最便宜的型号多少钱？"
}
```

预期分类：low_value

### 测试 Dock3

```json
{
  "message": "DJI Dock 3自动机场如何安装和部署？"
}
```

预期：product_tag="Dock3"，检索到安装手册

---

## 📊 成功标准

完成测试后，您应该看到：

1. ✅ **知识库工作**: AI 回答包含手册中的具体信息
2. ✅ **产品识别**: 正确识别 M30/M400/Dock3
3. ✅ **多轮对话**: 保持上下文连贯
4. ✅ **转人工触发**: 购买意向正确识别
5. ✅ **客户分类**: 大额采购识别为 high_value
6. ✅ **数据持久化**: 所有记录保存到数据库

---

## 💡 观察要点

### RAG 检索质量

- AI 是否引用了具体手册？
- 数据是否准确（续航、距离等）？
- 是否说"未找到相关信息"？

### LLM 推理能力

- 回答是否专业？
- 语气是否友好但不过分热情？
- 是否控制在 100 字以内？

### 转人工逻辑

- 哪些关键词触发转人工？
- 置信度阈值合理吗？
- 是否有误判？

---

**准备好了吗？打开 http://localhost:8000/docs 开始测试！** 🚀
