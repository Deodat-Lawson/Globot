# éƒ¨ç½²è¯´æ˜æ–‡æ¡£

**ç‰ˆæœ¬**: 1.0.0  
**ç›®æ ‡ç¯å¢ƒ**: ç”Ÿäº§ç¯å¢ƒ

---

## ğŸ“‹ ç›®å½•

1. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
2. [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
3. [æœ¬åœ°éƒ¨ç½²](#æœ¬åœ°éƒ¨ç½²)
4. [Docker éƒ¨ç½²](#dockeréƒ¨ç½²)
5. [äº‘æœåŠ¡éƒ¨ç½²](#äº‘æœåŠ¡éƒ¨ç½²)
6. [ç”Ÿäº§ç¯å¢ƒé…ç½®](#ç”Ÿäº§ç¯å¢ƒé…ç½®)
7. [ç›‘æ§ä¸ç»´æŠ¤](#ç›‘æ§ä¸ç»´æŠ¤)

---

## éƒ¨ç½²æ¶æ„

### æ¨èæ¶æ„å›¾

```mermaid
graph TB
    subgraph "Public Internet"
        U[ç”¨æˆ·/å‰ç«¯]
    end

    subgraph "Load Balancer"
        LB[Nginx]
    end

    subgraph "Application Layer"
        API1[FastAPI Instance 1]
        API2[FastAPI Instance 2]
    end

    subgraph "AI Service Layer"
        OLLAMA[Ollama LLM]
        CHROMA[Chroma Vector DB]
    end

    subgraph "Data Layer"
        PG[(PostgreSQL)]
        REDIS[(Redis Cache)]
    end

    U --> LB
    LB --> API1
    LB --> API2
    API1 --> OLLAMA
    API2 --> OLLAMA
    API1 --> CHROMA
    API2 --> CHROMA
    API1 --> PG
    API2 --> PG
    API1 --> REDIS
    API2 --> REDIS
```

---

## ç¯å¢ƒå‡†å¤‡

### ç¡¬ä»¶è¦æ±‚

#### æœ€ä½é…ç½®ï¼ˆå¼€å‘/æµ‹è¯•ï¼‰

- **CPU**: 4 æ ¸
- **å†…å­˜**: 8GB
- **å­˜å‚¨**: 50GB SSD
- **GPU**: æ— ï¼ˆCPU æ¨ç†ï¼‰

#### æ¨èé…ç½®ï¼ˆç”Ÿäº§ï¼‰

- **CPU**: 8 æ ¸+
- **å†…å­˜**: 16GB+
- **å­˜å‚¨**: 100GB+ SSD
- **GPU**: NVIDIA GPU 8GB+ VRAMï¼ˆå¯é€‰ï¼Œæ˜¾è‘—æå‡æ€§èƒ½ï¼‰

---

### è½¯ä»¶è¦æ±‚

| ç»„ä»¶           | ç‰ˆæœ¬è¦æ±‚                  | è¯´æ˜             |
| -------------- | ------------------------- | ---------------- |
| **OS**         | Ubuntu 20.04+ / CentOS 8+ | Linux æ¨è       |
| **Python**     | 3.10+                     | å¿…é¡»             |
| **Docker**     | 20.10+                    | å®¹å™¨åŒ–éƒ¨ç½²       |
| **PostgreSQL** | 14+                       | æ•°æ®åº“           |
| **Ollama**     | latest                    | LLM æ¨ç†å¼•æ“     |
| **Nginx**      | 1.18+                     | åå‘ä»£ç†ï¼ˆå¯é€‰ï¼‰ |

---

## æœ¬åœ°éƒ¨ç½²

### æ­¥éª¤ 1: å®‰è£…ç³»ç»Ÿä¾èµ–

#### Ubuntu/Debian

```bash
sudo apt update
sudo apt install -y python3.10 python3-pip python3-venv
sudo apt install -y docker.io docker-compose
sudo apt install -y git curl
```

#### CentOS/RHEL

```bash
sudo yum install -y python310 python3-pip
sudo yum install -y docker docker-compose
sudo yum install -y git curl
```

---

### æ­¥éª¤ 2: å®‰è£… Ollama

```bash
# ä¸‹è½½å®‰è£…è„šæœ¬
curl https://ollama.ai/install.sh | sh

# å¯åŠ¨æœåŠ¡
ollama serve &

# æ‹‰å–æ¨¡å‹
ollama pull qwen2.5:7b
```

éªŒè¯ï¼š

```bash
ollama list
# åº”æ˜¾ç¤º qwen2.5:7b
```

---

### æ­¥éª¤ 3: å…‹éš†é¡¹ç›®

```bash
git clone <your-repo-url>
cd ai-sales-mvp
```

---

### æ­¥éª¤ 4: é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
cd backend
cp .env.example .env
nano .env
```

**ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼š

```env
# æ•°æ®åº“ï¼ˆä½¿ç”¨å¼ºå¯†ç ï¼ï¼‰
DATABASE_URL=postgresql://prod_user:STRONG_PASSWORD@localhost:5432/dji_sales_prod

# Ollama
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=qwen2.5:7b

# å‘é‡åº“
CHROMA_PERSIST_DIR=/var/lib/dji-sales/chroma_db

# æ—¥å¿—
LOG_LEVEL=WARNING
DEBUG=False

# å®‰å…¨
SECRET_KEY=<ç”Ÿæˆä¸€ä¸ªéšæœºå¯†é’¥>
ALLOWED_HOSTS=yourdomain.com,api.yourdomain.com
```

ç”Ÿæˆ SECRET_KEYï¼š

```bash
python3 -c "import secrets; print(secrets.token_hex(32))"
```

---

### æ­¥éª¤ 5: å¯åŠ¨ PostgreSQL

```bash
cd backend
docker-compose up -d postgres

# éªŒè¯
docker ps | grep dji-postgres
```

---

### æ­¥éª¤ 6: å®‰è£… Python ä¾èµ–

```bash
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
```

---

### æ­¥éª¤ 7: æ„å»ºçŸ¥è¯†åº“

```bash
python scripts/build_kb.py
```

---

### æ­¥éª¤ 8: å¯åŠ¨åº”ç”¨

```bash
# å¼€å‘æ¨¡å¼
uvicorn main:app --host 0.0.0.0 --port 8000

# ç”Ÿäº§æ¨¡å¼ï¼ˆä½¿ç”¨Gunicornï¼‰
gunicorn main:app \
  --workers 4 \
  --worker-class uvicorn.workers.UvicornWorker \
  --bind 0.0.0.0:8000 \
  --log-level warning
```

---

## Docker éƒ¨ç½²

### æ–¹å¼ 1: Docker Composeï¼ˆæ¨èï¼‰

**åˆ›å»º `docker-compose.prod.yml`**:

```yaml
version: "3.8"

services:
  postgres:
    image: postgres:14
    container_name: dji-postgres-prod
    environment:
      POSTGRES_USER: prod_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: dji_sales_prod
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: always

  ollama:
    image: ollama/ollama:latest
    container_name: dji-ollama
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "11434:11434"
    restart: always
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu] # GPUåŠ é€Ÿï¼ˆå¯é€‰ï¼‰

  api:
    build: ./backend
    container_name: dji-sales-api
    depends_on:
      - postgres
      - ollama
    environment:
      - DATABASE_URL=postgresql://prod_user:${DB_PASSWORD}@postgres:5432/dji_sales_prod
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_MODEL=qwen2.5:7b
    volumes:
      - chroma_data:/app/chroma_db
      - ./backend/uploads:/app/uploads
    ports:
      - "8000:8000"
    restart: always
    command: >
      gunicorn main:app
      --workers 4
      --worker-class uvicorn.workers.UvicornWorker
      --bind 0.0.0.0:8000

  nginx:
    image: nginx:latest
    container_name: dji-nginx
    depends_on:
      - api
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    ports:
      - "80:80"
      - "443:443"
    restart: always

volumes:
  postgres_data:
  ollama_data:
  chroma_data:
```

**å¯åŠ¨**:

```bash
export DB_PASSWORD="your_strong_password"
docker-compose -f docker-compose.prod.yml up -d
```

---

### æ–¹å¼ 2: å•ç‹¬ Docker å®¹å™¨

**æ„å»ºé•œåƒ**:

```bash
cd backend
docker build -t dji-sales-api:1.0.0 .
```

**è¿è¡Œå®¹å™¨**:

```bash
docker run -d \
  --name dji-sales-api \
  -p 8000:8000 \
  -e DATABASE_URL="postgresql://..." \
  -e OLLAMA_BASE_URL="http://host.docker.internal:11434" \
  -v $(pwd)/chroma_db:/app/chroma_db \
  dji-sales-api:1.0.0
```

---

## äº‘æœåŠ¡éƒ¨ç½²

### AWS éƒ¨ç½²

#### æ¶æ„æ–¹æ¡ˆ

```
ELB (Load Balancer)
  â†“
ECS (Fargate) - FastAPIå®¹å™¨
  â†“
â”œâ”€â”€ RDS (PostgreSQL)
â”œâ”€â”€ EC2 (Ollama GPUå®ä¾‹)
â””â”€â”€ S3 (çŸ¥è¯†åº“æ–‡ä»¶)
```

#### æ­¥éª¤æ¦‚è§ˆ

1. **åˆ›å»º RDS å®ä¾‹**ï¼ˆPostgreSQL 14ï¼‰
2. **å¯åŠ¨ EC2 GPU å®ä¾‹**ï¼ˆå®‰è£… Ollamaï¼‰
3. **é…ç½® ECS ä»»åŠ¡å®šä¹‰**ï¼ˆFastAPI å®¹å™¨ï¼‰
4. **è®¾ç½® ALB**ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
5. **é…ç½®å®‰å…¨ç»„**ï¼ˆç½‘ç»œè§„åˆ™ï¼‰

---

### é˜¿é‡Œäº‘éƒ¨ç½²

#### æ¶æ„æ–¹æ¡ˆ

```
SLB (è´Ÿè½½å‡è¡¡)
  â†“
ECS (å¼¹æ€§è®¡ç®—) - Dockerå®¹å™¨
  â†“
â”œâ”€â”€ RDS (äº‘æ•°æ®åº“PostgreSQL)
â”œâ”€â”€ ECS GPU (Ollama)
â””â”€â”€ OSS (å¯¹è±¡å­˜å‚¨)
```

---

## ç”Ÿäº§ç¯å¢ƒé…ç½®

### 1. Nginx åå‘ä»£ç†

**`nginx.conf`**:

```nginx
upstream fastapi_backend {
    server api:8000;
    # å¦‚æœ‰å¤šä¸ªå®ä¾‹
    # server api2:8000;
}

server {
    listen 80;
    server_name yourdomain.com;

    # HTTPSé‡å®šå‘
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    server_name yourdomain.com;

    # SSLè¯ä¹¦
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # å®‰å…¨headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # APIä»£ç†
    location /api/ {
        proxy_pass http://fastapi_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # è¶…æ—¶è®¾ç½®ï¼ˆLLMæ¨ç†è¾ƒæ…¢ï¼‰
        proxy_connect_timeout 60s;
        proxy_read_timeout 60s;
    }

    # é™æµ
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    location /api/chat {
        limit_req zone=api_limit burst=5 nodelay;
        proxy_pass http://fastapi_backend;
    }
}
```

---

### 2. Systemd æœåŠ¡é…ç½®

**`/etc/systemd/system/dji-sales-api.service`**:

```ini
[Unit]
Description=DJI Sales AI Assistant API
After=network.target postgresql.service

[Service]
Type=notify
User=www-data
Group=www-data
WorkingDirectory=/opt/dji-sales-mvp/backend
Environment="PATH=/opt/dji-sales-mvp/venv/bin"
ExecStart=/opt/dji-sales-mvp/venv/bin/gunicorn main:app \
    --workers 4 \
    --worker-class uvicorn.workers.UvicornWorker \
    --bind 0.0.0.0:8000 \
    --log-file /var/log/dji-sales/api.log

Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**å¯ç”¨æœåŠ¡**:

```bash
sudo systemctl daemon-reload
sudo systemctl enable dji-sales-api
sudo systemctl start dji-sales-api
sudo systemctl status dji-sales-api
```

---

### 3. æ—¥å¿—ç®¡ç†

#### Logrotate é…ç½®

**`/etc/logrotate.d/dji-sales`**:

```
/var/log/dji-sales/*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        systemctl reload dji-sales-api
    endscript
}
```

---

### 4. æ•°æ®åº“å¤‡ä»½

**è‡ªåŠ¨å¤‡ä»½è„šæœ¬** (`/opt/scripts/backup_db.sh`):

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/dji-sales"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="dji_sales_prod"

# åˆ›å»ºå¤‡ä»½
pg_dump -U prod_user -h localhost $DB_NAME | gzip > \
    $BACKUP_DIR/db_backup_$DATE.sql.gz

# ä¿ç•™æœ€è¿‘7å¤©
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +7 -delete

echo "Backup completed: db_backup_$DATE.sql.gz"
```

**Crontab**:

```bash
# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
0 2 * * * /opt/scripts/backup_db.sh
```

---

## ç›‘æ§ä¸ç»´æŠ¤

### 1. å¥åº·æ£€æŸ¥

**ç›‘æ§è„šæœ¬**:

```bash
#!/bin/bash
# health_check.sh

API_URL="http://localhost:8000"
ALERT_EMAIL="admin@yourdomain.com"

# æ£€æŸ¥API
if ! curl -f "$API_URL/" > /dev/null 2>&1; then
    echo "APIæœåŠ¡å¼‚å¸¸ï¼" | mail -s "DJI Sales API Alert" $ALERT_EMAIL
    exit 1
fi

# æ£€æŸ¥Ollama
if ! curl -f "http://localhost:11434/api/tags" > /dev/null 2>&1; then
    echo "OllamaæœåŠ¡å¼‚å¸¸ï¼" | mail -s "Ollama Service Alert" $ALERT_EMAIL
    exit 1
fi

echo "æ‰€æœ‰æœåŠ¡æ­£å¸¸"
```

**Crontab**ï¼ˆæ¯ 5 åˆ†é’Ÿæ£€æŸ¥ï¼‰:

```bash
*/5 * * * * /opt/scripts/health_check.sh
```

---

### 2. æ€§èƒ½ç›‘æ§

æ¨èå·¥å…·ï¼š

- **Prometheus + Grafana**: æŒ‡æ ‡ç›‘æ§
- **ELK Stack**: æ—¥å¿—åˆ†æ
- **Sentry**: é”™è¯¯è¿½è¸ª

---

### 3. å¸¸è§ç»´æŠ¤ä»»åŠ¡

#### æ¸…ç†æ—§å¯¹è¯è®°å½•

```sql
-- åˆ é™¤30å¤©å‰çš„å¯¹è¯
DELETE FROM messages WHERE created_at < NOW() - INTERVAL '30 days';
DELETE FROM conversations WHERE created_at < NOW() - INTERVAL '30 days';
```

#### é‡å»ºçŸ¥è¯†åº“

```bash
cd /opt/dji-sales-mvp/backend
source ../venv/bin/activate
python scripts/build_kb.py
sudo systemctl restart dji-sales-api
```

---

## å®‰å…¨æ£€æŸ¥æ¸…å•

- [ ] ä¿®æ”¹é»˜è®¤æ•°æ®åº“å¯†ç 
- [ ] é…ç½®é˜²ç«å¢™è§„åˆ™
- [ ] å¯ç”¨ HTTPS/SSL
- [ ] é™åˆ¶ API è®¿é—®é€Ÿç‡
- [ ] å®šæœŸæ›´æ–°ä¾èµ–åŒ…
- [ ] é…ç½®æ—¥å¿—å®¡è®¡
- [ ] æ•°æ®åº“åŠ å¯†è¿æ¥
- [ ] ç¦ç”¨ DEBUG æ¨¡å¼
- [ ] é…ç½® CORS ç­–ç•¥
- [ ] å®æ–½ API è®¤è¯

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **API å“åº”æ…¢**

   - æ£€æŸ¥ Ollama CPU/GPU ä½¿ç”¨ç‡
   - å¢åŠ  Gunicorn worker æ•°é‡
   - å¯ç”¨ Redis ç¼“å­˜

2. **å†…å­˜ä¸è¶³**

   - å‡å°‘ Gunicorn worker
   - é™åˆ¶å¹¶å‘è¯·æ±‚æ•°
   - å‡çº§æœåŠ¡å™¨å†…å­˜

3. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   - æ£€æŸ¥è¿æ¥æ± è®¾ç½®
   - éªŒè¯é˜²ç«å¢™è§„åˆ™
   - æ£€æŸ¥ PostgreSQL æ—¥å¿—

---

**æœ€åæ›´æ–°**: 2025-12-24  
**ç»´æŠ¤äºº**: [Your Team]
